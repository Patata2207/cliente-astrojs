---
import DefaultLayout from "../layout/DefaultLayout.astro";
---

<DefaultLayout>
    <div class="max-w-7xl mx-auto p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-10">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Panel de Visitas</h1>
                <p class="text-sm text-white/60 mt-1">Gesti√≥n r√°pida y segura de registros</p>
            </div>
            <div class="flex gap-3">
                <button id="btnAgregar" class="group relative px-5 py-2.5 rounded-lg font-medium text-sm text-white bg-gradient-to-r from-indigo-500 to-fuchsia-500 shadow hover:shadow-lg hover:brightness-110 active:scale-[.97] transition">
                    <span class="inline-block group-hover:translate-y-[-2px] transition">+ Nueva Visita</span>
                </button>
                <button id="logout" class="px-5 py-2.5 rounded-lg font-medium text-sm bg-white/10 border border-white/20 text-white hover:bg-white/20 backdrop-blur transition">
                    Cerrar sesi√≥n
                </button>
            </div>
        </div>

        <!-- Bloque de anal√≠ticas -->
        <section class="mb-10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold flex items-center gap-2"><span>üìä</span>Anal√≠ticas Semanales</h2>
                <button id="btnRefrescarStats" class="text-xs px-3 py-1.5 rounded bg-white/10 border border-white/20 hover:bg-white/20 transition">Actualizar</button>
            </div>
            <div class="stats-card relative rounded-2xl p-6 overflow-hidden">
                <canvas id="visitasChart" height="110" aria-label="Gr√°fico de visitas por d√≠a" role="img"></canvas>
            </div>
        </section>

        <div id="visitas" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>

        <!-- Modal para agregar/editar visita -->
        <div id="modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="relative w-full max-w-lg">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-fuchsia-500 rounded-2xl opacity-70 blur"></div>
                <div class="relative bg-slate-900/90 rounded-2xl p-8 border border-white/10 shadow-xl">
                <h2 id="modalTitle" class="text-2xl font-semibold mb-6">Nueva Visita</h2>
                <form id="formVisita" class="space-y-5">
                    <input type="hidden" id="visitaId" />
                    <div>
                        <label class="block text-xs uppercase tracking-wide font-semibold mb-2 text-white/70">Nombre</label>
                        <input type="text" id="nombre" required class="w-full rounded-lg px-4 py-2.5 bg-white/5 border border-white/15 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none transition" />
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wide font-semibold mb-2 text-white/70">RUT</label>
                        <input type="text" id="rut" required class="w-full rounded-lg px-4 py-2.5 bg-white/5 border border-white/15 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none transition" />
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wide font-semibold mb-2 text-white/70">Motivo</label>
                        <textarea id="motivo" required class="w-full rounded-lg px-4 py-2.5 bg-white/5 border border-white/15 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none transition" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wide font-semibold mb-2 text-white/70">Hora Entrada</label>
                        <input type="datetime-local" id="horaEntrada" required class="w-full rounded-lg px-4 py-2.5 bg-white/5 border border-white/15 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none transition" />
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wide font-semibold mb-2 text-white/70">Hora Salida</label>
                        <input type="datetime-local" id="horaSalida" required class="w-full rounded-lg px-4 py-2.5 bg-white/5 border border-white/15 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none transition" />
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="submit" class="flex-1 bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white px-5 py-2.5 rounded-lg font-medium shadow hover:shadow-lg hover:brightness-110 active:scale-[.98] transition">Guardar</button>
                        <button type="button" id="btnCancelar" class="flex-1 bg-white/10 border border-white/15 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-white/20 transition">Cancelar</button>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>
</DefaultLayout>

<script>
    const API_URL = 'http://127.0.0.1:8000/visitas/';
    const visitasContainer = document.getElementById('visitas');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const formVisita = document.getElementById('formVisita');
    const btnAgregar = document.getElementById('btnAgregar');
    const btnCancelar = document.getElementById('btnCancelar');
    const logoutBtn = document.getElementById('logout');
    
    const token = window.sessionStorage.getItem('access_token');

    if (!token) {
        if (visitasContainer) {
            visitasContainer.innerHTML = '<p class="text-red-600">No hay token. Inicia sesi√≥n primero.</p>';
        }
    } else {
        cargarVisitas();
    }

    function getHeaders() {
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    async function cargarVisitas() {
        if (!visitasContainer) return;
        
        visitasContainer.innerHTML = '<p>Cargando visitas...</p>';

        try {
            const res = await fetch(API_URL, {
                method: 'GET',
                headers: getHeaders()
            });

            if (!res.ok) throw new Error('Error al obtener visitas');

            const data = await res.json();
            const visitas = Array.isArray(data) ? data : (data.results || [data]);

            console.log('Estructura de visitas:', visitas.length > 0 ? visitas[0] : 'sin datos');

            visitasContainer.innerHTML = '';

            if (visitas.length === 0) {
                visitasContainer.innerHTML = '<p class="text-gray-600">No hay visitas registradas.</p>';
                return;
            }

            // Determinar clave de ID real presente en los objetos
            const idKey = Object.keys(visitas[0]).find(k => ['id','pk','_id'].includes(k)) || null;
            if (!idKey) {
                const warning = document.createElement('div');
                warning.className = 'border border-yellow-400 bg-yellow-50 text-yellow-800 p-3 rounded mb-4';
                warning.innerHTML = '<strong>Advertencia:</strong> La API no devuelve un campo de identificaci√≥n (id/pk). No se puede eliminar ni actualizar sin duplicar. Agrega el campo <code>id</code> en el serializer del backend.';
                visitasContainer.appendChild(warning);
            }

            visitas.forEach((item: any, index: number) => {
                const visitaElement = document.createElement('div');
                visitaElement.className = 'visita-card rounded-xl p-5 shadow-md';
                
                // Usar la clave detectada (si existe)
                const visitaId = idKey ? item[idKey] : '';
                
                console.log(`Visita ${index}:`, { id: visitaId, nombre: item.nombre, todosLosCampos: Object.keys(item), idKey });
                
                visitaElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${item.nombre || '‚Äî'}</h3>
                            <span class="text-sm text-gray-600">${item.rut || '‚Äî'}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn-editar bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600" data-index="${index}">
                                Editar
                            </button>
                            ${idKey ? `<button class=\"btn-eliminar bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600\" data-id=\"${visitaId}\">Eliminar</button>` : ''}
                        </div>
                    </div>
                    <div class="mb-2">
                        <strong>Motivo:</strong>
                        <p class="whitespace-pre-wrap">${item.motivo || '‚Äî'}</p>
                    </div>
                    <div class="text-sm text-gray-700">
                        <div><strong>Entrada:</strong> ${formatDate(item.hora_entrada)}</div>
                        <div><strong>Salida:</strong> ${formatDate(item.hora_salida)}</div>
                    </div>
                `;
                visitasContainer.appendChild(visitaElement);
            });

            // Generar anal√≠ticas despu√©s de renderizar tarjetas
            generarEstadisticas(visitas);

            // Agregar event listeners a los botones
            document.querySelectorAll('.btn-editar').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target as HTMLElement;
                    const index = parseInt(target.dataset.index || '0');
                    editarVisita(index, visitas);
                });
            });

            if (idKey) {
                document.querySelectorAll('.btn-eliminar').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.target as HTMLElement;
                        const id = target.dataset.id;
                        console.log('Intentando eliminar ID:', id);
                        if (id && id !== '' && id !== 'undefined') {
                            eliminarVisita(id);
                        } else {
                            alert('Error: No se puede identificar la visita. Revisa la consola para m√°s detalles.');
                        }
                    });
                });
            }

        } catch (error) {
            console.error('Error fetching visitas:', error);
            visitasContainer.innerHTML = '<p class="text-red-600">Error al cargar las visitas</p>';
        }
    }

    // ----- Anal√≠ticas -----
    let visitasChart: any = null;
    const diasLabels = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];

    function generarEstadisticas(visitas: any[]) {
        const conteos = [0,0,0,0,0,0,0];
        visitas.forEach(v => {
            const fechaStr = v.hora_entrada || v.hora_salida;
            if (!fechaStr) return;
            const d = new Date(fechaStr);
            if (isNaN(d.getTime())) return;
            // getDay(): 0=Dom ... 6=Sab -> remap to our labels starting Monday
            const day = d.getDay();
            const index = (day === 0) ? 6 : day - 1; // Monday=0 ... Sunday=6
            conteos[index]++;
        });
        renderChart(conteos);
    }

    declare global {
        interface Window { Chart?: any }
    }

    function ensureChartJs(callback: () => void) {
        if (window.Chart) { callback(); return; }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
        script.onload = () => callback();
        document.head.appendChild(script);
    }

    function renderChart(data: number[]) {
        ensureChartJs(() => {
            const ctx = document.getElementById('visitasChart') as HTMLCanvasElement | null;
            if (!ctx) return;
            const darkMode = !document.documentElement.classList.contains('light');
            const gradient = ctx.getContext('2d')!.createLinearGradient(0,0,0,180);
            if (darkMode) {
                gradient.addColorStop(0,'rgba(99,102,241,0.55)');
                gradient.addColorStop(1,'rgba(236,72,153,0.15)');
            } else {
                gradient.addColorStop(0,'rgba(99,102,241,0.65)');
                gradient.addColorStop(1,'rgba(236,72,153,0.25)');
            }
            const textColor = darkMode ? '#ffffff' : '#1e293b';
            const gridColor = darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.1)';
            if (visitasChart) {
                visitasChart.data.datasets[0].data = data;
                visitasChart.options.scales.x.ticks.color = textColor;
                visitasChart.options.scales.y.ticks.color = textColor;
                visitasChart.options.scales.x.grid.color = gridColor;
                visitasChart.options.scales.y.grid.color = gridColor;
                visitasChart.data.datasets[0].backgroundColor = gradient;
                visitasChart.update();
                return;
            }
            visitasChart = new (window as any).Chart(ctx, {
                type: 'bar',
                data: {
                    labels: diasLabels,
                    datasets: [{
                        label: 'Visitas',
                        data,
                        borderRadius: 6,
                        backgroundColor: gradient,
                        borderColor: 'rgba(255,255,255,0.4)',
                        borderWidth: 1.2,
                        hoverBackgroundColor: 'rgba(236,72,153,0.55)'
                    }]
                },
                options: {
                    responsive: true,
                    animation: { duration: 650, easing: 'easeOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: darkMode ? 'rgba(30,41,59,0.9)' : 'rgba(255,255,255,0.95)',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: darkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.15)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor, font: { weight: '600' } } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor }, beginAtZero: true, suggestedMax: Math.max(...data) + 1 }
                    }
                }
            });
        });
    }

    // Bot√≥n manual de refresco
    const btnRefrescarStats = document.getElementById('btnRefrescarStats');
    btnRefrescarStats?.addEventListener('click', () => cargarVisitas());

    // Re-render chart al cambiar tema
    const themeObserver = new MutationObserver(() => {
        if (visitasChart) {
            // Forzar re-render con √∫ltimos datos
            const currentData = visitasChart.data.datasets[0].data as number[];
            renderChart(currentData);
        }
    });
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

    function formatDate(d?: string) {
        if (!d) return '-';
        try {
            const dt = new Date(d);
            return isNaN(dt.getTime()) ? d : dt.toLocaleString();
        } catch {
            return d;
        }
    }

    function toISOLocal(date: Date) {
        const offset = date.getTimezoneOffset();
        const adjustedDate = new Date(date.getTime() - offset * 60 * 1000);
        return adjustedDate.toISOString().slice(0, 16);
    }

    function abrirModal(titulo: string) {
        if (modalTitle) modalTitle.textContent = titulo;
        if (modal) modal.classList.remove('hidden');
    }

    function cerrarModal() {
        if (modal) modal.classList.add('hidden');
        if (formVisita) (formVisita as HTMLFormElement).reset();
        const visitaIdInput = document.getElementById('visitaId') as HTMLInputElement;
        if (visitaIdInput) visitaIdInput.value = '';
    }

    function editarVisita(index: number, visitas: any[]) {
        const visita = visitas[index];
        if (!visita) return;

        const visitaId = visita.id || visita.pk || '';
        console.log('Editando visita con ID:', visitaId, 'Visita completa:', visita);
        
        (document.getElementById('visitaId') as HTMLInputElement).value = String(visitaId);
        (document.getElementById('nombre') as HTMLInputElement).value = visita.nombre || '';
        (document.getElementById('rut') as HTMLInputElement).value = visita.rut || '';
        (document.getElementById('motivo') as HTMLTextAreaElement).value = visita.motivo || '';
        
        if (visita.hora_entrada) {
            (document.getElementById('horaEntrada') as HTMLInputElement).value = toISOLocal(new Date(visita.hora_entrada));
        }
        if (visita.hora_salida) {
            (document.getElementById('horaSalida') as HTMLInputElement).value = toISOLocal(new Date(visita.hora_salida));
        }

        abrirModal('Editar Visita');
        
        // Verificar que el ID se guard√≥ correctamente
        setTimeout(() => {
            const savedId = (document.getElementById('visitaId') as HTMLInputElement).value;
            console.log('ID guardado en input hidden:', savedId);
        }, 100);
    }

    async function eliminarVisita(id: string) {
        console.log('=== ELIMINAR VISITA ===');
        console.log('ID recibido:', id, 'tipo:', typeof id);
        
        if (!id || id === 'undefined' || id.trim() === '') {
            alert('No se puede eliminar: ID no v√°lido. Verifica la estructura de datos de la API.');
            console.error('ID inv√°lido para eliminar');
            return;
        }

        if (!confirm('¬øEst√°s seguro de eliminar esta visita?')) return;

        const deleteUrl = `${API_URL}${id}/`;
        console.log('URL DELETE:', deleteUrl);

        try {
            const res = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: getHeaders()
            });

            console.log('Respuesta DELETE:', res.status, res.statusText);

            if (!res.ok) {
                const errorText = await res.text();
                console.error('Error del servidor:', errorText);
                throw new Error('Error al eliminar visita');
            }

            alert('Visita eliminada correctamente');
            cargarVisitas();
        } catch (error) {
            console.error('Error completo:', error);
            alert('Error al eliminar la visita. Revisa la consola para m√°s detalles.');
        }
    }

    // Event listeners
    if (btnAgregar) {
        btnAgregar.addEventListener('click', () => {
            abrirModal('Nueva Visita');
        });
    }

    if (btnCancelar) {
        btnCancelar.addEventListener('click', cerrarModal);
    }

    if (formVisita) {
        formVisita.addEventListener('submit', async (e) => {
            e.preventDefault();

            const visitaId = (document.getElementById('visitaId') as HTMLInputElement).value;
            console.log('Submit - visitaId del input:', visitaId, 'tipo:', typeof visitaId);
            
            const nombre = (document.getElementById('nombre') as HTMLInputElement).value;
            const rut = (document.getElementById('rut') as HTMLInputElement).value;
            const motivo = (document.getElementById('motivo') as HTMLTextAreaElement).value;
            const horaEntrada = (document.getElementById('horaEntrada') as HTMLInputElement).value;
            const horaSalida = (document.getElementById('horaSalida') as HTMLInputElement).value;

            const visitaData = {
                nombre,
                rut,
                motivo,
                hora_entrada: new Date(horaEntrada).toISOString(),
                hora_salida: new Date(horaSalida).toISOString()
            };

            try {
                let url, method;
                
                // Verificar si visitaId tiene un valor v√°lido
                const isEdit = visitaId && visitaId.trim() !== '' && visitaId !== 'undefined';
                
                if (isEdit) {
                    // Editar: usar PUT para reemplazo completo
                    url = `${API_URL}${visitaId}/`;
                    method = 'PUT';
                    console.log('Editando visita ID:', visitaId, 'URL:', url);
                } else {
                    // Crear nueva
                    url = API_URL;
                    method = 'POST';
                    console.log('Creando nueva visita en:', url);
                }

                console.log('Enviando:', method, url, visitaData);

                const res = await fetch(url, {
                    method,
                    headers: getHeaders(),
                    body: JSON.stringify(visitaData)
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => null);
                    console.error('Error del servidor:', res.status, errorData);
                    throw new Error(`Error al ${isEdit ? 'actualizar' : 'crear'} visita`);
                }

                const resultado = await res.json();
                console.log('Respuesta del servidor:', resultado);

                alert(`Visita ${isEdit ? 'actualizada' : 'creada'} correctamente`);
                cerrarModal();
                cargarVisitas();
            } catch (error) {
                console.error('Error:', error);
                alert(`Error al ${visitaId ? 'actualizar' : 'crear'} la visita`);
            }
        });
    }

    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            window.sessionStorage.removeItem('access_token');
            window.sessionStorage.removeItem('refresh_token');
            window.location.href = '/login';
        });
    }
</script>
<style>
    /* Tarjetas con contenedor visible en ambos temas */
    .visita-card {
        position:relative;
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.18);
        backdrop-filter:blur(12px);
        color:#ffffff;
        transition:background .25s,border-color .25s,transform .25s,box-shadow .25s;
    }
    .visita-card:hover {background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.35);box-shadow:0 6px 20px -6px rgba(0,0,0,.55);transform:translateY(-3px);}    
    .visita-card h3 {font-weight:600;font-size:1.05rem;margin:0 0 .15rem;letter-spacing:.25px;color:#ffffff;}
    .visita-card strong {color:#ffffff;font-weight:600;}
    .visita-card p, .visita-card span, .visita-card div {color:#ffffff;}
    .visita-card .text-gray-600, .visita-card .text-gray-700 {color:#ffffff !important;}
    .visita-card .whitespace-pre-wrap {color:#ffffff;}
    .btn-editar, .btn-eliminar {font-size:.70rem;font-weight:600;padding:.45rem .65rem;border-radius:.55rem;line-height:1;letter-spacing:.5px;}
    .btn-editar {background:#d4a60b;}
    .btn-editar:hover {background:#eab308;}
    .btn-eliminar {background:#dc2626;}
    .btn-eliminar:hover {background:#ef4444;}
    html.light .visita-card {background:#ffffff;color:#1e293b;border:1px solid #e2e8f0;box-shadow:0 6px 18px -4px rgba(0,0,0,.15);}    
    html.light .visita-card:hover {background:#ffffff;border-color:#cbd5e1;}
    html.light .visita-card h3 {color:#0f172a;}
    html.light .visita-card p, html.light .visita-card span, html.light .visita-card div {color:#334155;}
    html.light .visita-card strong {color:#0f172a;}
</style>
